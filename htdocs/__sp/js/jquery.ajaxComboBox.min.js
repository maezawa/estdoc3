(function(){function w(x,y,w){function G(){$(b.results).children("li").on("mouseover",function(){$(b.results).children("li").removeClass(h.select);$(this).addClass(h.select);D()}).on("mousedown",function(c){c.preventDefault();c.stopPropagation();a:{c=z();var a=$(b.container).offset().top,A;d.size_li=$(b.results).children("li:first").height;A=d.size_li;var l=document.documentElement.clientHeight,f=0<document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop,h=f+l-A,m;if($(c).length)if(a<f||A>l)m=a-f;else if(a>h)m=a-h;else break a;else a<f&&(m=a-f);window.scrollBy(0,m)}if(m=z())$(b.combo_input).val($(m).text()),$(b.hidden).val($(m).attr("pkey")),d.prev_value=$(b.combo_input).val(),B();e.bind_to&&$(b.combo_input).trigger(e.bind_to,!1);$(b.combo_input).focus();$(b.combo_input).change();r()})}function r(){$(b.results).addClass(h.re_off);$(b.combo_input).removeClass(h.input_off)}function D(){$(b.results).removeClass(h.re_off);$(b.combo_input).addClass(h.input_off)}function E(){d.timer_valchange=setTimeout(H,500)}function H(){var c=$(b.combo_input).val();c!=d.prev_value&&(d.prev_value=c,$(b.hidden).val(""),d.page_suggest=1,d.is_suggest=!0,$.ajax({url:"http://api.estdoc.jp/geo?callback=?&name="+c,success:function(a,c){e.source=a.body;var l=d.is_suggest?$(b.combo_input).val().replace(/(^\s+)|(\s+$)/g,""):"";if(1>l.length&&d.is_suggest)B();else{l=l.split(/[\s\u3000]+/);F();""==$(b.results).html()&&(C(),$(b.container).addClass(h.container_open));if(d.is_paging){var f=z();d.is_paging=f?$(b.results).children("li").index(f):-1}else d.is_suggest||(d.is_paging=0);f=d.is_suggest?d.page_suggest:d.page_all;"object"==typeof e.source&&I(l,f)}},error:function(a,c,b){console.log(c)}}));$(b.result_area).css("border","1px solid #79b");E()}function F(){d.xhr&&(d.xhr.abort(),d.xhr=!1)}function I(c,a){function d(a,c){return a[e.order_by[0][0]].localeCompare(c[e.order_by[0][0]])}function l(a,c){return c[e.order_by[0][0]].localeCompare(a[e.order_by[0][0]])}var f=[],q=[],m=[],k={},g=0,s=[];do q[g]=c[g].replace(/\W/g,"\\$&").toString(),s[g]=RegExp(q[g],"gi"),g++;while(g<c.length);for(g=0;g<e.source.length;g++){for(var n=!1,p=0,t=s.length;p<t;p++)if(e.source[g][e.field].match(s[p])){if(n=!0,"OR"==e.and_or)break}else if(n=!1,"AND"==e.and_or)break;n&&f.push(e.source[g])}if(void 0==f.length)$(b.results).empty(),C(),$(b.container).addClass(h.container_open),r();else{k.cnt_whole=f.length;for(var s=RegExp("^"+q[0]+"$","gi"),q=RegExp("^"+q[0],"gi"),n=[],p=[],u=[],g=0,t=f.length;g<t;g++)f[g][e.order_by[0][0]].match(s)?n.push(f[g]):f[g][e.order_by[0][0]].match(q)?p.push(f[g]):u.push(f[g]);e.order_by[0][1].match(/^asc$/i)?(n.sort(d),p.sort(d),u.sort(d)):(n.sort(l),p.sort(l),u.sort(l));m=m.concat(n).concat(p).concat(u);g=(a-1)*e.per_page;f=g+e.per_page;for(t=0;g<f&&void 0!=m[g];g++,t++)for(var v in m[g])v==e.primary_key&&(void 0==k.primary_key&&(k.primary_key=[]),k.primary_key.push(m[g][v])),v==e.field&&(void 0==k.candidate&&(k.candidate=[]),k.candidate.push(m[g][v]));k.cnt_page="undefined"===typeof k.candidate?0:k.candidate.length;J(k,c,a)}}function J(c,a,e){c.primary_key||(c.primary_key=!1);a=c.candidate;c=c.primary_key;$(b.results).empty();e="undefined"===typeof a?0:a.length;for(var l=0;l<e;l++){var f=$("<li>").text(a[l]).attr({pkey:c[l],title:a[l]});$(b.results).append(f)}C();$(b.container).addClass(h.container_open);G();!1===d.is_paging?r():(a=d.is_paging,c=$(b.results).children("li").length-1,a>c&&(a=c),a=$(b.results).children("li").eq(a),$(a).addClass(h.select),d.is_paging=!1,D())}function C(){var c=$(b.combo_input).parent().offset(),a=$(b.combo_input).offset();$(b.result_area).css({top:a.top+$(b.combo_input).height+"px",left:a.left-c.left+"px"});$(b.result_area).show()}function B(){r();$(b.results).empty();$(b.result_area).hide();$(b.container).removeClass(h.container_open);F()}function z(){if($(b.result_area).is(":hidden"))return!1;var c=$(b.results).children("li."+h.select);return $(c).length?c:!1}var e=function(c,a){a=$.extend({source:c,field:"name",and_or:"AND",per_page:10,navi_num:5,primary_key:"id",bind_to:!1,navi_simple:!1},a);a.search_field=void 0==a.search_field?a.field:a.search_field;a.and_or=a.and_or.toUpperCase();for(var b=["search_field"],d=0,f=b.length;d<f;d++)a[b[d]]=a[b[d]].replace(/[\s\u3000]+/g,"").split(",");a.order_by=void 0==a.order_by?a.search_field:a.order_by;var b=a,d=a.order_by,e=a.field,f=[];if("object"==typeof d)for(var e=0,h=d.length;e<h;e++){var k=d[e].replace(/(^\s+)|(\s+$)/g,"").split(" ");f[e]=2==k.length?k:[k[0],"ASC"]}else k=d.replace(/(^\s+)|(\s+$)/g,"").split(" "),f[0]=2==k.length?k:k[0].match(/^(ASC|DESC)$/i)?[e,k[0]]:[k[0],"ASC"];b.order_by=f;return a}(y,w),h=function(){var b={container:"ac_container",container_open:"ac_container_open",selected:"ac_selected",re_area:"ac_result_area",results:"ac_results",re_off:"ac_results_off",select:"ac_over",input_off:"ac_input_off"};return b=$.extend(b,{input:"ac_s_input"})}(),d={timer_valchange:!1,is_suggest:!1,page_all:1,page_suggest:1,max_all:1,max_suggest:1,is_paging:!1,is_loading:!1,xhr:!1,prev_value:""},b=function(b){var a={};a.combo_input=$(b).attr("autocomplete","off").addClass(h.input);a.container=$(a.combo_input);a.result_area=$("<div>").addClass(h.re_area);a.results=$("<ul>").addClass(h.results);b=$(a.combo_input).attr("id");a.hidden=$('<input type="hidden" />').attr({name:b,id:b}).val("");$(a.result_area).insertAfter($(a.container));$(a.hidden).insertAfter($(a.result_area));$(a.result_area).append(a.results);return a}(x);(function(){$(b.combo_input).focus(E).on("click",function(){r();$(b.results).children("li").removeClass(h.select)})})();(function(){var c=!1;$(b.container).on("mousedown",function(a){c=!0});$("html").on("mousedown",function(){c?c=!1:B()})})();return!0}$.fn.ajaxComboBox=function(x,y){return this.each(function(){w(this,x,y)})}})($);